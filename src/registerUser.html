<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Mobile Theft Detection</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <img src="https://img.shields.io/badge/mobiguard-%23FA0F00.svg?style=for-the-badge&logo=ethereum&logoColor=white">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="index.html">Home |</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="register.html" style="border:1px solid blue;border-radius: 20px; padding:4px; margin-top: 10px;">Register Device |</a>
            </li>

            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="about.html">About |</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="devices.html">Devices |</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="devicesLost.html">Lost Devices |</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="https://sadam452.github.io/portfolio/" title="External site">Developer |</a>
            </li>
          </ul>
          <form class="d-flex" role="search">
            <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success" type="submit">Search</button>
          </form>
        </div>
      </div>
    </nav>

    <div class="container" style="margin-left: 25%; width: 50%;">
     <h1>Register a user</h1> <hr>
     <form class="row g-3">
        <div class="col-md-6">
          <label for="inputEmail4" class="form-label">Email</label>
          <input type="email" class="form-control email" id="inputEmail4">
        </div>
        <div class="col-md-6">
          <label for="inputPassword4" class="form-label">Password</label>
          <input type="password" class="form-control password" id="inputPassword4">
        </div>
        <div class="col-12">
          <label for="inputAddress" class="form-label">Address</label>
          <input type="text" class="form-control address" id="inputAddress" placeholder="1234 Main St">
        </div>
        <!-- <div class="col-12">
          <label for="inputAddress2" class="form-label">Address 2</label>
          <input type="text" class="form-control" id="inputAddress2" placeholder="Apartment, studio, or floor">
        </div> -->
        <div class="col-md-6">
          <label for="inputName" class="form-label">Name</label>
          <input type="text" class="form-control name" id="inputName">
        </div>
        <div class="col-md-4">
          <label for="inputState" class="form-label">Country</label>
          <input type="text" class="form-control state" id="inputState">
        </div>
        <div class="col-md-2">
          <label for="inputZip" class="form-label">Zip</label>
          <input type="text" class="form-control zip" id="inputZip">
        </div>
        <!-- <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="gridCheck">
            <label class="form-check-label" for="gridCheck">
              Check me out
            </label>
          </div>
        </div> -->
        <div class="col-12">
          <button type="submit" class="btn btn-primary btn-register">Sign in</button>
        </div>
        
      </form>
      Have created account already? <a href="login.html">Login</a>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->

    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/web3.min.js"></script>
    <!-- <script src="js/truffle-contract.js"></script> -->
    <!-- <script src="js/app.js"></script> -->
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.3/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@truffle/contract@4.3.5/dist/truffle-contract.js"></script>
    <script>
        App = {
            web3Provider: null,
            contracts: {},

            init: async function() {
                return await App.initWeb3();
            },

            initWeb3: async function() {
                // Initialize web3 provider
                if (window.ethereum) {
                App.web3Provider = window.ethereum;
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    console.log("Web3 enabled by user");
                } catch (error) {
                    console.error("User denied account access:", error);
                }
                } else if (window.web3) {
                App.web3Provider = window.web3.currentProvider;
                } else {
                console.error("No web3 provider detected, falling back to localhost");
                App.web3Provider = new Web3.providers.HttpProvider('http://localhost:7545');
                }
                web3 = new Web3(App.web3Provider);

                return App.initContract();
            },

            initContract: function() {
                // Load Adoption contract artifact
                $.getJSON('MobileDevice.json', function(data) {
                    // Initialize contract with the loaded artifact
                    var MobileDeviceArtifact = data;
                    App.contracts.MobileDevice = TruffleContract(MobileDeviceArtifact);
                    App.contracts.MobileDevice.setProvider(App.web3Provider);
                    console.log("Contract loaded");
                    //check if any device is already sold or lost
                    // console.error('Contract loaded. Marking adopted devices...');
                    // App.initListDevices();
                }).fail(function() {
                    console.error("Failed to load contract");
                });

                // Bind events
                return App.bindEvents();
            },

            bindEvents: function() {
                $(document).on('click', '.btn-register', App.registerUser);
            },
            registerUser: function(event) {
                event.preventDefault();
                var email = document.querySelector('.email').value;
                var password = document.querySelector('.password').value;
                var address = document.querySelector('.address').value;
                var name = document.querySelector('.name').value;
                var state = document.querySelector('.state').value;
                var zip = document.querySelector('.zip').value;
                console.log("Received values: " + " " + email + " " + password + " " + address + " " + name + " " + state + " " + zip);

                // Check if any value is empty
                if (email === "" || password === "" || address === "" || name === "" || state === "" || zip === "") {
                    alert("Please fill all the fields.");
                    return;
                }

                console.log("Registering user...");

                // Call the registerUser function in the smart contract
                var adoptionInstance;
                web3.eth.getAccounts(function(error, accounts) {
                    if (error) {
                        console.error(error);
                    }

                    var account = accounts[0];
                    console.log("Account: " + account);
                    App.contracts.MobileDevice.deployed().then(function(instance) {
                        adoptionInstance = instance;
                        console.log("called register user");
                        return adoptionInstance.registerUser(email, password, address, state, zip, name, { from: account });
                    }).then(function(result) {
                        console.log("User registered:", result);
                        alert("User registered successfully");
                    }).catch(function(err) {
                        alert("Error registering a user[This email is used or any network issue].");
                        console.error("Error registering a user.", err.message);
                    });
                });
            }

            };
        $(function() {
        $(window).load(function() {
            App.init();
        });
        });
    </script>
  </body>
</html>
